name: Nightly Build
on: 
  schedule: 
    - cron: 0 0 * * *
  workflow_dispatch:
jobs:
  main:
    name: Fetch The Lastet V2ray Source Code,Modify,And Build
    runs-on: ubuntu-20.04
    steps: 
    - name: SetUpGoEnv
      run: |
        sudo apt install -y wget git
        wget -q https://golang.google.cn/dl/go1.19.5.linux-amd64.tar.gz
        sudo tar -C /usr/local -xzf go1.19.5.linux-amd64.tar.gz
        /usr/local/go/bin/go version
    - name: FetchAndBuild
      run: |
        git clone https://github.com/v2fly/v2ray-core.git
        tar -zcvf v2ray-core-source.tar.gz ./v2ray-core
        wget -q https://github.com/upx/upx/releases/download/v4.0.1/upx-4.0.1-amd64_linux.tar.xz
        tar -xvf upx-4.0.1-amd64_linux.tar.xz
        /usr/local/go/bin/go build ./v2ray-core/main/...
        ./upx-4.0.1-amd64_linux/upx -1 ./v2ray-core/main/main
        chmod 777 ./v2ray-core/main/main
    - name: Commit files
      run: |
        git config --global user.email "github@github.com"
        git config --global user.name "Github Actions"
        git pull
        cd goorm
        mv ../v2ray-core/main/main ./
        mv ../v2ray-core-source.tar.gz ./
        git add .
        git commit -m "Nightly Build By Github Actions"
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ screts.MY_TOKEN }}
        branch: master
    
